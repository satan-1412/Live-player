<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER</title>
    
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000;
            --surface: #151515;
            --primary: #00ff88;
            --text: #fff;
            --text-sub: #888;
        }
        body.root-mode {
            --surface: #250510;
            --primary: #ff0055;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }

        /* ================== 布局容器 ================== */
        /* 默认显示大厅，隐藏播放器 */
        #lobby-view { display: flex; flex-direction: column; height: 100%; width: 100%; z-index: 10; }
        #player-view { display: none; flex-direction: column; height: 100%; width: 100%; z-index: 20; position: absolute; top: 0; left: 0; background: var(--bg); }

        /* 激活播放器时 */
        body.view-player #lobby-view { display: none; }
        body.view-player #player-view { display: flex; }

        /* ================== 1. 大厅样式 ================== */
        header {
            padding: 12px 15px; background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; gap: 15px; flex-shrink: 0;
        }
        .logo { font-size: 20px; font-weight: 900; color: var(--primary); letter-spacing: -1px; padding: 5px; }
        .logo.triggering { color: #fff; text-shadow: 0 0 10px var(--primary); }
        
        .search-wrap { flex: 1; background: #222; border-radius: 6px; padding: 0 10px; display: flex; align-items: center; }
        .search-input { width: 100%; background: transparent; border: none; padding: 10px 0; color: #fff; font-size: 14px; }
        
        #category-bar {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; background: #000;
            border-bottom: 1px solid #222; flex-shrink: 0;
        }
        .cat-tag {
            padding: 5px 12px; border-radius: 15px; background: #222; color: #aaa; font-size: 12px; white-space: nowrap;
        }
        .cat-tag.active { background: var(--primary); color: #000; font-weight: bold; }

        #channel-grid {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; /* 强制两列 */
            align-content: start;
        }
        
        /* 卡片设计修复 */
        .card { background: var(--surface); border-radius: 6px; overflow: hidden; position: relative; }
        .card-img-box {
            width: 100%; aspect-ratio: 16/9; background: #111; position: relative;
        }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-fallback {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center; color: #333; font-size: 24px;
        }
        .card-title {
            padding: 8px 5px; font-size: 13px; text-align: center; color: #ddd;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ================== 2. 播放器样式 (强制竖屏结构) ================== */
        /* 上半部分：视频 (固定高度) */
        #video-area {
            width: 100%; height: 35vh; background: #000; position: relative; flex-shrink: 0;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        #dm-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .p-top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: linear-gradient(rgba(0,0,0,0.8), transparent);
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px;
            pointer-events: none; z-index: 50;
        }
        .btn-icon { padding: 10px; font-size: 18px; color: #fff; pointer-events: auto; text-shadow: 0 1px 2px #000; }
        .live-label {
            background: #e60000; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 3px;
            font-weight: bold; display: none; align-items: center; gap: 4px;
        }
        .live-dot { width: 5px; height: 5px; background: #fff; border-radius: 50%; }

        /* 下半部分：信息+列表 (填满剩余) */
        #info-area {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg);
        }
        
        .ch-details {
            padding: 12px 15px; background: var(--surface); border-bottom: 1px solid #222;
            display: flex; align-items: center; gap: 10px;
        }
        .ch-logo-small { width: 40px; height: 40px; border-radius: 4px; background: #000; object-fit: contain; }
        
        .playlist { flex: 1; overflow-y: auto; padding: 0 10px; }
        .play-item {
            padding: 12px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; color: #ccc;
        }
        .play-item.active { color: var(--primary); font-weight: bold; }
        
        /* 底部弹幕栏 */
        .dm-ctrl {
            padding: 8px 10px; background: #111; border-top: 1px solid #333;
            display: flex; align-items: center; gap: 10px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        .dm-input {
            flex: 1; background: #222; border: none; border-radius: 20px;
            height: 36px; padding: 0 15px; color: #fff; font-size: 13px;
        }
        .dm-btn {
            width: 36px; height: 36px; border-radius: 50%; background: var(--primary);
            color: #000; display: flex; align-items: center; justify-content: center;
        }

        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px;
            font-size: 13px; pointer-events: none; opacity: 0; transition: 0.3s;
        }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>

<div id="lobby-view">
    <header>
        <div class="logo" id="logo-btn">OSB</div>
        <div class="search-wrap">
            <i class="fas fa-search" style="color:#666; margin-right:5px;"></i>
            <input class="search-input" id="search" placeholder="搜索频道...">
        </div>
    </header>
    
    <div id="category-bar"></div>
    
    <div id="channel-grid">
        <div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;">
            <i class="fas fa-sync fa-spin"></i> 正在连接服务器...
        </div>
    </div>
</div>

<div id="player-view">
    <div id="video-area">
        <video id="video" playsinline webkit-playsinline controls></video>
        <canvas id="dm-canvas"></canvas>
        <div class="p-top-bar">
            <div class="btn-icon" onclick="backToLobby()"><i class="fas fa-chevron-down"></i></div>
            <div class="live-label" id="live-tag"><div class="live-dot"></div> LIVE</div>
            <div class="btn-icon" onclick="toggleFS()"><i class="fas fa-expand"></i></div>
        </div>
    </div>
    
    <div id="info-area">
        <div class="ch-details">
            <img id="p-logo" class="ch-logo-small">
            <div>
                <div id="p-title" style="font-size:15px; font-weight:bold;">--</div>
                <div id="p-sub" style="font-size:12px; color:#666; margin-top:2px;">信号: 自动 | 线路: HLS</div>
            </div>
        </div>
        
        <div class="playlist" id="playlist"></div>
        
        <div class="dm-ctrl">
            <input class="dm-input" id="dm-text" placeholder="发送全网弹幕...">
            <div class="dm-btn" onclick="sendDm()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // ================= 系统配置 =================
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqttBroker: 'wss://broker.emqx.io:8084/mqtt'
    };

    let app = { mode: 'SAFE', data: [], cat: 'ALL', current: null, hls: null, mqtt: null, topic: null };

    // ================= 初始化 =================
    window.onload = () => {
        initLogo();
        initMQTT();
        initCanvas();
        loadData(CONFIG.safeUrl);
    };

    function toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 2000);
    }

    // ================= 1. 数据处理 =================
    function loadData(url) {
        toast("正在更新列表...");
        fetch(url + '?t=' + Date.now())
            .then(r => r.text())
            .then(txt => {
                app.data = [];
                const lines = txt.split('\n');
                for(let i=0; i<lines.length; i++){
                    if(lines[i].startsWith('#EXTINF')){
                        const info = lines[i].split(',')[1] || '频道';
                        const logo = (lines[i].match(/tvg-logo="([^"]+)"/)||[])[1];
                        const group = (lines[i].match(/group-title="([^"]+)"/)||[])[1] || '其它';
                        const url = lines[i+1]?.trim();
                        if(url && url.startsWith('http')) app.data.push({title:info, logo:logo, group:group, url:url});
                    }
                }
                renderLobby();
            })
            .catch(() => toast("加载失败，请检查网络"));
    }

    // ================= 2. 渲染大厅 =================
    function renderLobby() {
        // 分类
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        const bar = document.getElementById('category-bar');
        bar.innerHTML = '';
        groups.forEach(g => {
            const el = document.createElement('div');
            el.className = `cat-tag ${g===app.cat?'active':''}`;
            el.innerText = g;
            el.onclick = () => { app.cat=g; renderLobby(); };
            bar.appendChild(el);
        });

        // 宫格
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = '';
        const search = document.getElementById('search').value.toLowerCase();
        
        const list = app.data.filter(d => {
            return (app.cat==='ALL' || d.group===app.cat) && d.title.toLowerCase().includes(search);
        });

        if(list.length === 0) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#555;">无相关频道</div>';

        list.forEach(d => {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => openPlayer(d);
            
            let imgHtml = `<div class="card-fallback"><i class="fas fa-tv"></i></div>`;
            if(d.logo) imgHtml = `<img src="${d.logo}" class="card-img" onerror="this.style.display='none'">`;
            
            el.innerHTML = `<div class="card-img-box">${imgHtml}</div><div class="card-title">${d.title}</div>`;
            grid.appendChild(el);
        });
    }

    document.getElementById('search').oninput = renderLobby;

    // ================= 3. 播放器逻辑 =================
    const v = document.getElementById('video');
    const hls = new Hls({
        xhrSetup: (xhr) => { xhr.withCredentials = false; } // 关键：禁用 Cookie 发送，减少 403 概率
    });

    function openPlayer(d) {
        app.current = d;
        document.body.classList.add('view-player');
        
        // 更新信息
        document.getElementById('p-title').innerText = d.title;
        document.getElementById('p-sub').innerText = `分类: ${d.group}`;
        document.getElementById('p-logo').src = d.logo || '';
        
        // 播放源
        if(Hls.isSupported()) {
            hls.loadSource(d.url);
            hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PAR
