<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | V7</title>
    
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ================== V7.0 è§†è§‰ä¿®å¤ ================== */
        :root {
            --bg: #121212;
            --card: #252525;
            --primary: #00ff88;
            --text: #eee;
            --dim: #888;
        }
        body.root-mode { --bg: #200510; --card: #351020; --primary: #ff0055; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- 1. å¤§å… (Lobby) --- */
        #lobby-view { 
            flex: 1; display: flex; flex-direction: column; 
            transition: transform 0.3s ease; z-index: 10;
        }

        /* é¡¶éƒ¨æ  */
        .header { 
            padding: 12px 16px; background: rgba(30,30,30,0.95); 
            display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 20px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }
        .logo.triggering { color: #fff; text-shadow: 0 0 10px var(--primary); }
        
        .search-wrap { flex: 1; position: relative; }
        .search-input { 
            width: 100%; background: #333; border: none; border-radius: 8px; 
            padding: 8px 35px 8px 10px; color: #fff; font-size: 14px;
        }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; }

        /* åˆ†ç±»æ ‡ç­¾ */
        .nav-tabs { 
            padding: 10px 16px; display: flex; gap: 10px; overflow-x: auto; 
            border-bottom: 1px solid rgba(255,255,255,0.05); scrollbar-width: none;
        }
        .tab { 
            padding: 6px 14px; background: rgba(255,255,255,0.08); 
            border-radius: 20px; font-size: 13px; color: #bbb; white-space: nowrap; 
        }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }

        /* å®«æ ¼ä¿®å¤ï¼šå›¾ç‰‡ä¸å†æœ‰é»‘æ¡ */
        .grid { 
            flex: 1; padding: 16px; overflow-y: auto; 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; 
            align-content: start;
        }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }

        .card { background: var(--card); border-radius: 8px; overflow: hidden; position: relative; }
        .card-img-wrap { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; } /* å…³é”®ï¼šcover å¡«æ»¡ */
        .card-fallback { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; color: #333; 
        }
        .card-title { 
            padding: 10px; font-size: 13px; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        /* --- 2. æ’­æ”¾å™¨ (Player) --- */
        #player-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 20;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        body.in-player #player-view { transform: translateX(0); }

        /* ä¸ŠåŠéƒ¨åˆ†ï¼šè§†é¢‘ (å›ºå®šé«˜åº¦) */
        .video-stage {
            width: 100%; height: 240px; background: #000; position: relative; flex-shrink: 0;
        }
        /* æ¨ªå±æˆ–å…¨å±æ—¶é“ºæ»¡ */
        @media (orientation: landscape) { .video-stage { height: 100vh; } }
        .video-stage.fullscreen { position: fixed; height: 100%; z-index: 100; }

        video { width: 100%; height: 100%; }
        /* å¼¹å¹•ç”»å¸ƒ */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* é¡¶éƒ¨æµ®å±‚ */
        .p-head {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            background: linear-gradient(rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .btn-back { pointer-events: auto; font-size: 22px; color: #fff; padding: 5px; filter: drop-shadow(0 0 3px #000); }
        .live-tag { 
            background: #f00; color: #fff; font-size: 10px; padding: 2px 6px; 
            border-radius: 4px; font-weight: bold; display: none; 
        }

        /* ä¸‹åŠéƒ¨åˆ†ï¼šè¯¦æƒ… (è‡ªé€‚åº”) */
        .p-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid #333; }
        
        .ch-info { padding: 12px 16px; background: var(--card); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ch-title { font-size: 16px; font-weight: bold; margin: 0; }
        .ch-sub { font-size: 12px; color: var(--dim); margin-top: 4px; }

        .playlist { flex: 1; overflow-y: auto; padding: 10px 0; }
        .play-item { 
            padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        .play-item.active { color: var(--primary); background: rgba(255,255,255,0.05); }
        .play-item.active i { display: block; }
        .play-item i { display: none; }

        /* åº•éƒ¨è¾“å…¥æ¡† (é˜²é®æŒ¡æ ¸å¿ƒè®¾è®¡) */
        .dm-bar {
            padding: 10px 16px; background: #1a1a1a; border-top: 1px solid #333;
            display: flex; gap: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .dm-input {
            flex: 1; height: 36px; background: #333; border: none; border-radius: 18px;
            padding: 0 15px; color: #fff; font-size: 14px;
        }
        .dm-send {
            width: 36px; height: 36px; background: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #000;
        }

        /* é”®ç›˜å¼¹èµ·æ—¶ï¼Œéšè—åˆ—è¡¨ï¼Œåªç•™è§†é¢‘å’Œè¾“å…¥æ¡† */
        @media (max-height: 500px) {
            .p-body { justify-content: flex-end; }
            .playlist, .ch-info { display: none; }
        }

        /* é”™è¯¯æç¤º */
        #toast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 6px; 
            color: #fff; font-size: 14px; display: none; z-index: 999; text-align: center;
        }
    </style>
</head>
<body>

<div id="lobby-view">
    <div class="header">
        <div class="logo" id="logo-trigger">OSB<span style="font-size:12px;opacity:0.6">PRO</span></div>
        <div class="search-wrap">
            <input type="text" class="search-input" id="search" placeholder="æœç´¢é¢‘é“...">
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>
    <div class="nav-tabs" id="tabs"></div>
    <div class="grid" id="grid">
        <div style="grid-column:1/-1;text-align:center;padding:50px;color:#666;">
            <i class="fas fa-spinner fa-spin"></i> è¿æ¥å«æ˜Ÿä¿¡å·...
        </div>
    </div>
</div>

<div id="player-view">
    <div class="video-stage" id="stage">
        <video id="video" playsinline webkit-playsinline controls></video>
        <canvas id="canvas"></canvas>
        <div class="p-head">
            <div class="btn-back" onclick="exitPlayer()"><i class="fas fa-chevron-left"></i></div>
            <div class="live-tag" id="live-tag">LIVE</div>
            <div style="width:24px"></div> </div>
    </div>

    <div class="p-body">
        <div class="ch-info">
            <h1 class="ch-title" id="p-title">--</h1>
            <div class="ch-sub" id="p-sub">åˆ†ç±»: --</div>
        </div>
        <div class="playlist" id="playlist"></div>
        
        <div class="dm-bar">
            <input type="text" class="dm-input" id="dm-input" placeholder="å…¨ç½‘å¼¹å¹•...">
            <div class="dm-send" onclick="sendDm()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // ================= ç³»ç»Ÿæ ¸å¿ƒé…ç½® =================
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqttBroker: 'wss://broker.emqx.io:8084/mqtt'
    };

    let app = { 
        mode: 'SAFE', data: [], currentCh: null, cat: 'ALL', 
        mqtt: null, topic: null 
    };

    // ================= åˆå§‹åŒ– =================
    window.onload = () => {
        initLogo();
        initMQTT();
        initCanvas();
        loadData(CONFIG.safeUrl);
    };

    // ================= 1. æ•°æ®åŠ è½½ (é˜²å´©æºƒ) =================
    function loadData(url) {
        toast("æ­£åœ¨åŒæ­¥é¢‘é“...");
        fetch(url + '?t=' + Date.now())
            .then(r => r.text())
            .then(parseM3U8)
            .catch(() => toast("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"));
    }

    function parseM3U8(txt) {
        app.data = [];
        const lines = txt.split('\n');
        lines.forEach((line, i) => {
            if (line.startsWith('#EXTINF')) {
                const info = line.split(',')[1] || 'é¢‘é“ ' + i;
                // æå– Logoï¼Œå¦‚æœæå–ä¸åˆ°ï¼Œç»™ä¸ªç©ºå­—ç¬¦ä¸²
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1] || '';
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || 'å…¶å®ƒ';
                const url = (lines[i+1] || '').trim();
                
                if (url && url.startsWith('http')) {
                    app.data.push({ title: info, logo: logo, group: group, url: url });
                }
            }
        });
        
        if (app.data.length === 0) {
            document.getElementById('grid').innerHTML = '<div style="text-align:center;padding:50px;">æš‚æ— é¢‘é“</div>';
        } else {
            renderLobby();
        }
    }

    // ================= 2. å¤§å…æ¸²æŸ“ (Lobby) =================
    function renderLobby() {
        // æ¸²æŸ“åˆ†ç±»
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        const tabs = document.getElementById('tabs');
        tabs.innerHTML = '';
        groups.forEach(g => {
            const btn = document.createElement('div');
            btn.className = `tab ${g === app.cat ? 'active' : ''}`;
            btn.innerText = g;
            btn.onclick = () => { app.cat = g; renderLobby(); };
            tabs.appendChild(btn);
        });

        // æ¸²æŸ“å¡ç‰‡
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const search = document.getElementById('search').value.toLowerCase();
        
        const list = app.data.filter(d => {
            if (app.cat !== 'ALL' && d.group !== app.cat) return false;
            if (search && !d.title.toLowerCase().includes(search)) return false;
            return true;
        });

        list.forEach(d => {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => openPlayer(d);
            
            // åªæœ‰å½“ d.logo å­˜åœ¨æ—¶æ‰æ˜¾ç¤º imgï¼Œå¦åˆ™æ˜¾ç¤ºå›¾æ ‡
            // ä¿®å¤å›¾ç‰‡é»‘æ¡ï¼šCSS å·²ç»åŠ äº† object-fit: cover
            let img = `<div class="card-fallback"><i class="fas fa-tv"></i></div>`;
            if (d.logo) {
                img = `<div class="card-img-wrap"><img src="${d.logo}" class="card-img" onerror="this.style.display='none'"></div>` + img;
            } else {
                img = `<div class="card-img-wrap">` + img + `</div>`;
            }

            el.innerHTML = `${img}<div class="card-title">${d.title}</div>`;
            grid.appendChild(el);
        });
    }

    document.getElementById('search').oninput = renderLobby;

    // ================= 3. æ’­æ”¾æ ¸å¿ƒ (è§£å†³æ²¹ç®¡/æ³°å›½å°) =================
    const v = document.getElementById('video');
    const hls = new Hls({
        // æ ¸å¿ƒä¿®å¤ï¼šä¸å‘é€ Cookieï¼Œè§£å†³æ²¹ç®¡è·¨åŸŸé—®é¢˜
        xhrSetup: (xhr) => { xhr.withCredentials = false; }
    });

    function openPlayer(d) {
        if (!d) return; // é˜²å´©æºƒ
        app.currentCh = d;
        document.body.classList.add('in-player');
        
        // æ¸²æŸ“è¯¦æƒ…ï¼ˆå°±ç®—æ•°æ®ç¼ºå¤±ä¹Ÿä¸ä¼šå´©ï¼‰
        document.getElementById('p-title').innerText = d.title || 'æœªçŸ¥é¢‘é“';
        document.getElementById('p-sub').innerText = `åˆ†ç±»: ${d.group || 'æ— '}`;
        
        // æ’­æ”¾é€»è¾‘
        if (Hls.isSupported()) {
            hls.loadSource(d.url);
            hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PARSED, () => v.play());
        } else {
            // è‹¹æœæ‰‹æœº / ç§»åŠ¨ç«¯æµè§ˆå™¨åŸç”Ÿæ”¯æŒ HLS
            // è¿™æ˜¯è§£å†³æ³°å›½å°/æ²¹ç®¡çš„å…³é”®ï¼
            v.src = d.url;
            v.play();
        }

        // æ¸²æŸ“ä¸‹æ–¹åŒç±»åˆ—è¡¨
        renderPlaylist(d.group);
        // åˆ‡æ¢å¼¹å¹•æˆ¿é—´
        switchTopic(d.title);

        // æ£€æŸ¥æ˜¯ä¸æ˜¯ç›´æ’­
        v.onloadedmetadata = () => {
            const isLive = v.duration === Infinity || v.duration > 86400;
            document.getElementById('live-tag').style.display = isLive ? 'block' : 'none';
        };
    }

    function renderPlaylist(group) {
        const list = document.getElementById('playlist');
        list.innerHTML = '';
        app.data.filter(d => d.group === group).forEach(d => {
            const el = document.createElement('div');
            el.className = `play-item ${d === app.currentCh ? 'active' : ''}`;
            el.onclick = () => openPlayer(d);
            el.innerHTML = `<span>${d.title}</span><i class="fas fa-play"></i>`;
            list.appendChild(el);
        });
    }

    function exitPlayer() {
        document.body.classList.remove('in-player');
        v.pause();
    }

    // ================= 4. å¼¹å¹• & MQTT =================
    const canvas = document.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    let dms = [];

    function initMQTT() {
        try {
            app.mqtt = mqtt.connect(CONFIG.mqttBroker);
            app.mqtt.on('message', (t, m) => fireDm(m.toString(), false));
        } catch(e) {}
    }

    function switchTopic(title) {
        if (!app.mqtt || !title) return;
        const id = btoa(encodeURIComponent(title)).replace(/=/g,'');
        const newTopic = 'osb/v7/' + id;
        if (app.topic) app.mqtt.unsubscribe(app.topic);
        app.topic = newTopic;
        app.mqtt.subscribe(newTopic);
        dms = [];
    }

    function sendDm() {
        const inp = document.getElementById('dm-input');
        const txt = inp.value.trim();
        if (!txt) return;
        if (app.mqtt && app.topic) app.mqtt.publish(app.topic, txt);
        fireDm(txt, true);
        inp.value = '';
    }

    function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = 240; // ä¸ video é«˜åº¦ä¸€è‡´
        ctx.font = "bold 20px Arial";
        loop();
    }
    
    function fireDm(text, self) {
        dms.push({
            text, x: canvas.width, y: 30 + Math.random() * (canvas.height - 50),
            speed: 2 + Math.random(), color: self ? '#00ff88' : '#fff'
        });
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        dms.forEach((d, i) => {
            d.x -= d.speed;
            ctx.fillStyle = d.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
            ctx.strokeText(d.text, d.x, d.y); ctx.fillText(d.text, d.x, d.y);
            if (d.x < -500) dms.splice(i, 1);
        });
        requestAnimationFrame(loop);
    }

    // ================= 5. å½©è›‹é€»è¾‘ =================
    function initLogo() {
        const logo = document.getElementById('logo-trigger');
        let timer;
        const start = () => { logo.classList.add('triggering'); timer = setTimeout(toggleMode, 10000); };
        const end = () => { clearTimeout(timer); logo.classList.remove('triggering'); };
        ['mousedown','touchstart'].forEach(e => logo.addEventListener(e, start));
        ['mouseup','touchend'].forEach(e => logo.addEventListener(e, end));
    }

    function toggleMode() {
        app.mode = app.mode === 'SAFE' ? 'ROOT' : 'SAFE';
        document.body.classList.toggle('root-mode', app.mode === 'ROOT');
        toast(app.mode === 'ROOT' ? "ğŸ”“ éšç§æ¨¡å¼" : "ğŸ›¡ï¸ å®‰å…¨æ¨¡å¼");
        loadData(app.mode === 'ROOT' ? CONFIG.rootUrl : CONFIG.safeUrl);
        if (navigator.vibrate) navigator.vibrate(500);
    }

    function toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>
